{% extends "view/layout/front.html" %}
{% block content %}
<div class="min-h-screen px-6 py-12">
    <div class="max-w-6xl mx-auto">
        <div class="mb-8">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-baseline gap-4">
                    <h1 class="text-3xl font-bold text-white">üîî SSE Notifications_</h1>
                    <span id="status" class="px-3 py-1 bg-zinc-900 border border-zinc-800 text-xs text-gray-400">
                            üî¥ Disconnected
                        </span>
                </div>
                <a href="/" class="text-gray-500 hover:text-red-500 transition-colors text-sm">
                    ‚Üê Back
                </a>
            </div>
            <p class="text-gray-400">Real-time server-to-client notifications using Server-Sent Events</p>
        </div>
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Notifications Feed -->
            <div class="lg:col-span-2 bg-zinc-950 border border-zinc-800" style="height: 600px;">
                <div class="p-4 border-b border-zinc-800 flex justify-between items-center">
                    <div class="text-white font-bold">Live Feed</div>
                    <button onclick="clearNotifications()" class="text-gray-500 hover:text-red-500 text-sm transition-colors">
                        Clear
                    </button>
                </div>

                <div id="notifications" class="h-full overflow-y-auto p-4 space-y-2">
                    <!-- Notifications appear here -->
                </div>
            </div>

            <!-- Info Panel -->
            <div class="space-y-6">
                <!-- Connection Info -->
                <div class="bg-zinc-950 border border-zinc-800 p-6">
                    <div class="text-white font-bold mb-4">Connection Info</div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Protocol</span>
                            <span class="text-gray-300">SSE</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Endpoint</span>
                            <span class="text-gray-300">/notifications/stream</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Status</span>
                            <span id="statusText" class="text-gray-400">Disconnected</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Received</span>
                            <span id="count" class="text-gray-300">0</span>
                        </div>
                    </div>
                </div>

                <!-- Notification Types -->
                <div class="bg-zinc-950 border border-zinc-800 p-6">
                    <div class="text-white font-bold mb-4">Types</div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                            <span class="text-gray-400 text-sm">Info</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-gray-400 text-sm">Success</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                            <span class="text-gray-400 text-sm">Warning</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                            <span class="text-gray-400 text-sm">Alert</span>
                        </div>
                    </div>
                </div>

                <!-- Features -->
                <div class="bg-zinc-950 border border-zinc-800 p-6">
                    <div class="text-white font-bold mb-4">Features</div>
                    <div class="space-y-2">
                        <div class="flex items-start gap-2">
                            <span class="text-red-500">‚úì</span>
                            <span class="text-gray-400 text-sm">Auto-reconnection</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-red-500">‚úì</span>
                            <span class="text-gray-400 text-sm">Server ‚Üí Client only</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-red-500">‚úì</span>
                            <span class="text-gray-400 text-sm">HTTP/2 compatible</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-red-500">‚úì</span>
                            <span class="text-gray-400 text-sm">Built-in browser support</span>
                        </div>
                    </div>
                </div>

                <div class="bg-zinc-950 border border-zinc-800 p-6">
                    <div class="text-white font-bold mb-4">Implementation</div>
                    <div class="bg-black border border-zinc-800 p-3 text-xs">
                            <pre class="text-gray-400"><code>const source = new EventSource(
  '/notifications/stream'
);

source.onmessage = (e) => {
  const data = JSON.parse(e.data);
  console.log(data);
};</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    let eventSource;
    let count = 0;
    const notificationsDiv = document.getElementById('notifications');
    const status = document.getElementById('status');
    const statusText = document.getElementById('statusText');
    const countSpan = document.getElementById('count');

    const typeColors = {
        'Info': 'border-l-blue-500 bg-blue-950/20',
        'Success': 'border-l-green-500 bg-green-950/20',
        'Warning': 'border-l-yellow-500 bg-yellow-950/20',
        'Alert': 'border-l-red-500 bg-red-950/20'
    };

    const typeIcons = {
        'Info': '‚ÑπÔ∏è',
        'Success': '‚úÖ',
        'Warning': '‚ö†Ô∏è',
        'Alert': 'üö®'
    };

    function connect() {
        eventSource = new EventSource('/notifications/stream');

        eventSource.onopen = function() {
            status.innerHTML = 'üü¢ Connected';
            status.className = 'px-3 py-1 bg-green-900/30 border border-green-700 text-xs text-green-400';
            statusText.textContent = 'Connected';
            statusText.className = 'text-green-400';
            addSystemMessage('Connected to notification stream');
        };

        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                addNotification(data);
                count++;
                countSpan.textContent = count;
            } catch(e) {
                console.error('Failed to parse notification:', e);
            }
        };

        eventSource.onerror = function() {
            status.innerHTML = 'üî¥ Disconnected';
            status.className = 'px-3 py-1 bg-zinc-900 border border-zinc-800 text-xs text-gray-400';
            statusText.textContent = 'Disconnected';
            statusText.className = 'text-gray-400';
            addSystemMessage('Connection lost. Reconnecting...');
            eventSource.close();
        };
    }

    function addNotification(data) {
        const notifDiv = document.createElement('div');
        const colorClass = typeColors[data.type] || typeColors['Info'];
        const icon = typeIcons[data.type] || typeIcons['Info'];

        notifDiv.className = `notification p-3 bg-zinc-900 border border-zinc-800 border-l-4 ${colorClass}`;

        notifDiv.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="text-xl">${icon}</div>
                <div class="flex-1">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-white text-sm font-bold">${data.type}</span>
                        <span class="text-gray-600 text-xs">${data.time}</span>
                    </div>
                    <div class="text-gray-300 text-sm">${data.message}</div>
                </div>
            </div>
        `;

        notificationsDiv.insertBefore(notifDiv, notificationsDiv.firstChild);

        // Limiter √† 50 notifications
        while (notificationsDiv.children.length > 50) {
            notificationsDiv.removeChild(notificationsDiv.lastChild);
        }
    }

    function addSystemMessage(message) {
        const sysDiv = document.createElement('div');
        const time = new Date().toLocaleTimeString('fr-FR', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });

        sysDiv.className = 'notification p-3 bg-zinc-900 border border-zinc-800';
        sysDiv.innerHTML = `
            <div class="flex justify-between items-center">
                <span class="text-gray-500 text-sm">‚öôÔ∏è ${message}</span>
                <span class="text-gray-600 text-xs">${time}</span>
            </div>
        `;

        notificationsDiv.insertBefore(sysDiv, notificationsDiv.firstChild);
    }

    function clearNotifications() {
        notificationsDiv.innerHTML = '';
        count = 0;
        countSpan.textContent = '0';
        addSystemMessage('Notifications cleared');
    }

    // Auto-connect au chargement
    window.addEventListener('load', connect);
</script>
{% endblock %}